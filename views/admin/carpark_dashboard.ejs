<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title><%= carpark.name %> Dashboard - ANPR Admin</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="/css/style.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css" rel="stylesheet">
    <link href="https://cdn.datatables.net/1.13.7/css/dataTables.bootstrap5.min.css" rel="stylesheet">
    <link href="https://cdn.datatables.net/buttons/2.4.2/css/buttons.bootstrap5.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css" rel="stylesheet">
    <script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .chart-container {
            position: relative;
            height: 300px;
            margin-bottom: 20px;
        }
        .card {
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .card-header {
            font-weight: bold;
        }
        .dataTables_wrapper .dataTables_filter {
            margin-bottom: 1rem;
        }
        .dt-buttons {
            margin-bottom: 1rem;
        }
        .event-image {
            max-width: 100%;
            height: auto;
            border-radius: 4px;
            cursor: pointer;
            transition: transform 0.2s;
        }
        .event-image:hover {
            transform: scale(1.05);
        }
        .custom-date-range {
            display: none;
            margin-top: 10px;
        }
        .custom-date-range.active {
            display: block;
        }
        .filter-badge {
            margin-right: 5px;
            margin-bottom: 5px;
        }
    </style>
</head>
<body>
    <div class="container mt-4">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1><%= carpark.name %> Dashboard</h1>
            <a href="/admin/carparks" class="btn btn-secondary">Back to Car Parks</a>
        </div>

        <!-- Stats Cards Row -->
        <div class="row mb-4">
            <div class="col-md-4">
                <div class="card">
                    <div class="card-header bg-primary text-white">
                        <h5 class="card-title mb-0">Current Occupancy</h5>
                    </div>
                    <div class="card-body text-center">
                        <h2 class="display-4"><%= currentOccupancy %></h2>
                        <p class="text-muted">Vehicles Currently Parked</p>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card">
                    <div class="card-header bg-success text-white">
                        <h5 class="card-title mb-0">Today's Stats</h5>
                    </div>
                    <div class="card-body">
                        <div class="d-flex justify-content-between mb-2">
                            <span>Total Vehicles:</span>
                            <span class="fw-bold"><%= todayStats.totalVehicles %></span>
                        </div>
                        <div class="d-flex justify-content-between mb-2">
                            <span>Through Traffic:</span>
                            <span class="fw-bold"><%= todayStats.throughTraffic %></span>
                        </div>
                        <div class="d-flex justify-content-between">
                            <span>Avg Duration:</span>
                            <span class="fw-bold"><%= Number(todayStats.avgDuration || 0).toFixed(2) %> minutes</span>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card">
                    <div class="card-header bg-info text-white">
                        <h5 class="card-title mb-0">Quick Stats</h5>
                    </div>
                    <div class="card-body">
                        <div class="d-flex justify-content-between mb-2">
                            <span>Monthly Total:</span>
                            <span class="fw-bold"><%= monthlyStats.reduce((sum, stat) => sum + Number(stat.totalVehicles || 0), 0) %></span>
                        </div>
                        <div class="d-flex justify-content-between mb-2">
                            <span>Monthly Through:</span>
                            <span class="fw-bold"><%= monthlyStats.reduce((sum, stat) => sum + Number(stat.throughTraffic || 0), 0) %></span>
                        </div>
                        <div class="d-flex justify-content-between">
                            <span>Avg Stay:</span>
                            <span class="fw-bold"><%= (monthlyStats.reduce((sum, stat) => sum + Number(stat.avgDuration || 0), 0) / (monthlyStats.length || 1)).toFixed(2) %> min</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Charts Row -->
        <div class="row mb-4">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header bg-primary text-white">
                        <h5 class="card-title mb-0">Today's Hourly Distribution</h5>
                    </div>
                    <div class="card-body">
                        <div class="chart-container">
                            <canvas id="hourlyChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header bg-success text-white">
                        <h5 class="card-title mb-0">Average Stay by Day of Week</h5>
                    </div>
                    <div class="card-body">
                        <div class="chart-container">
                            <canvas id="dailyChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Monthly Trends Chart -->
        <div class="row mb-4">
            <div class="col-md-12">
                <div class="card">
                    <div class="card-header bg-info text-white">
                        <h5 class="card-title mb-0">Monthly Trends</h5>
                    </div>
                    <div class="card-body">
                        <div class="chart-container">
                            <canvas id="monthlyChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Current Vehicles and Recent Events -->
        <div class="row">
            <div class="col-md-6 mb-4">
                <div class="card">
                    <div class="card-header bg-warning text-dark">
                        <h5 class="card-title mb-0">Currently Parked Vehicles</h5>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>VRM</th>
                                        <th>Entry Time</th>
                                        <th>Duration</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <% currentVehicles.forEach(vehicle => { %>
                                        <tr>
                                            <td><%= vehicle.VRM %></td>
                                            <td><%= new Date(vehicle.entryTime).toLocaleString() %></td>
                                            <td><%= Math.round((new Date() - new Date(vehicle.entryTime)) / 60000) %> min</td>
                                        </tr>
                                    <% }); %>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-6 mb-4">
                <div class="card">
                    <div class="card-header bg-danger text-white">
                        <h5 class="card-title mb-0">Recent Events</h5>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>VRM</th>
                                        <th>Entry</th>
                                        <th>Exit</th>
                                        <th>Duration</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <% recentEvents.forEach(event => { %>
                                        <tr>
                                            <td><%= event.VRM %></td>
                                            <td><%= new Date(event.entryTime).toLocaleString() %></td>
                                            <td><%= event.exitTime ? new Date(event.exitTime).toLocaleString() : 'Still Parked' %></td>
                                            <td><%= event.durationMinutes ? Math.round(event.durationMinutes) + ' min' : '-' %></td>
                                        </tr>
                                    <% }); %>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Detailed Events Analysis -->
        <div class="row mb-4">
            <div class="col-md-12">
                <div class="card">
                    <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                        <h5 class="card-title mb-0">Detailed Events Analysis</h5>
                        <div class="btn-group">
                            <button type="button" class="btn btn-light btn-sm" onclick="exportEvents()">
                                <i class="bi bi-download"></i> Export
                            </button>
                            <button type="button" class="btn btn-light btn-sm" onclick="refreshEvents()">
                                <i class="bi bi-arrow-clockwise"></i> Refresh
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                        <!-- Filters -->
                        <div class="row mb-3">
                            <div class="col-md-3">
                                <label class="form-label">Date Range</label>
                                <select class="form-select" id="dateRange">
                                    <option value="today">Today</option>
                                    <option value="yesterday">Yesterday</option>
                                    <option value="week">Last 7 Days</option>
                                    <option value="month">Last 30 Days</option>
                                    <option value="custom">Custom Range</option>
                                </select>
                                <div id="customDateRange" class="custom-date-range">
                                    <div class="row mt-2">
                                        <div class="col-6">
                                            <input type="text" class="form-control" id="startDate" placeholder="Start Date">
                                        </div>
                                        <div class="col-6">
                                            <input type="text" class="form-control" id="endDate" placeholder="End Date">
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">Duration Filter</label>
                                <select class="form-select" id="durationFilter">
                                    <option value="all">All Durations</option>
                                    <option value="short">Short (< 30 min)</option>
                                    <option value="medium">Medium (30 min - 2 hours)</option>
                                    <option value="long">Long (> 2 hours)</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">Event Type</label>
                                <select class="form-select" id="eventType">
                                    <option value="all">All Events</option>
                                    <option value="completed">Completed</option>
                                    <option value="ongoing">Ongoing</option>
                                    <option value="through">Through Traffic</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">Search VRM</label>
                                <input type="text" class="form-control" id="vrmSearch" placeholder="Enter VRM...">
                            </div>
                        </div>
                        <div class="row mb-3">
                            <div class="col-12">
                                <div id="activeFilters"></div>
                            </div>
                        </div>

                        <!-- Events Table -->
                        <div class="table-responsive">
                            <table class="table table-hover" id="eventsTable">
                                <thead>
                                    <tr>
                                        <th>VRM</th>
                                        <th>Entry Time</th>
                                        <th>Exit Time</th>
                                        <th>Duration</th>
                                        <th>Type</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <% recentEvents.forEach(event => { %>
                                        <tr>
                                            <td><%= event.VRM %></td>
                                            <td><%= new Date(event.entryTime).toLocaleString() %></td>
                                            <td><%= event.exitTime ? new Date(event.exitTime).toLocaleString() : 'Still Parked' %></td>
                                            <td><%= event.durationMinutes ? Math.round(event.durationMinutes) + ' min' : '-' %></td>
                                            <td>
                                                <% if (!event.exitTime) { %>
                                                    <span class="badge bg-warning">Ongoing</span>
                                                <% } else if (event.durationMinutes < 30) { %>
                                                    <span class="badge bg-info">Through Traffic</span>
                                                <% } else { %>
                                                    <span class="badge bg-success">Completed</span>
                                                <% } %>
                                            </td>
                                            <td>
                                                <button class="btn btn-sm btn-outline-primary" onclick="viewEventDetails('<%= event.id %>')">
                                                    <i class="bi bi-eye"></i> View
                                                </button>
                                            </td>
                                        </tr>
                                    <% }); %>
                                </tbody>
                            </table>
                        </div>

                        <!-- Pagination -->
                        <nav aria-label="Events pagination">
                            <ul class="pagination justify-content-center">
                                <li class="page-item disabled">
                                    <a class="page-link" href="#" tabindex="-1">Previous</a>
                                </li>
                                <li class="page-item active"><a class="page-link" href="#">1</a></li>
                                <li class="page-item"><a class="page-link" href="#">2</a></li>
                                <li class="page-item"><a class="page-link" href="#">3</a></li>
                                <li class="page-item">
                                    <a class="page-link" href="#">Next</a>
                                </li>
                            </ul>
                        </nav>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Event Details Modal -->
    <div class="modal fade" id="eventDetailsModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Event Details</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6">
                            <h6>Entry Details</h6>
                            <div id="entryDetails">
                                <!-- Filled dynamically -->
                            </div>
                        </div>
                        <div class="col-md-6">
                            <h6>Exit Details</h6>
                            <div id="exitDetails">
                                <!-- Filled dynamically -->
                            </div>
                        </div>
                    </div>
                    <div class="row mt-3">
                        <div class="col-12">
                            <h6>Images</h6>
                            <div class="row" id="eventImages">
                                <!-- Filled dynamically -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Image Modal -->
    <div class="modal fade" id="imageModal" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Image View</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body text-center">
                    <img id="modalImage" class="img-fluid" alt="Event Image">
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.7/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.7/js/dataTables.bootstrap5.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.4.2/js/dataTables.buttons.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.4.2/js/buttons.bootstrap5.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.53/pdfmake.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.53/vfs_fonts.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.4.2/js/buttons.html5.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.4.2/js/buttons.print.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script>
        // Wait for DOM to be fully loaded
        document.addEventListener('DOMContentLoaded', function() {
            // Prepare chart data
            const hourlyData = <%- JSON.stringify(hourlyDistribution.map(h => ({ hour: h.hour + ':00', count: Number(h.count) }))) %>;
            const dailyData = <%- JSON.stringify(dailyStats.map(d => ({ day: d.day, avgDuration: Number(d.avgDuration || 0) }))) %>;
            const monthlyData = <%- JSON.stringify(monthlyStats.map(m => ({ 
                month: m.month, 
                totalVehicles: Number(m.totalVehicles),
                throughTraffic: Number(m.throughTraffic)
            }))) %>;

            // Hourly Distribution Chart
            new Chart(document.getElementById('hourlyChart'), {
                type: 'bar',
                data: {
                    labels: hourlyData.map(h => h.hour),
                    datasets: [{
                        label: 'Vehicles',
                        data: hourlyData.map(h => h.count),
                        backgroundColor: 'rgba(54, 162, 235, 0.5)',
                        borderColor: 'rgba(54, 162, 235, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 1
                            }
                        }
                    }
                }
            });

            // Daily Stats Chart
            new Chart(document.getElementById('dailyChart'), {
                type: 'bar',
                data: {
                    labels: dailyData.map(d => d.day),
                    datasets: [{
                        label: 'Average Duration (minutes)',
                        data: dailyData.map(d => d.avgDuration),
                        backgroundColor: 'rgba(75, 192, 192, 0.5)',
                        borderColor: 'rgba(75, 192, 192, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });

            // Monthly Trends Chart
            new Chart(document.getElementById('monthlyChart'), {
                type: 'line',
                data: {
                    labels: monthlyData.map(m => m.month),
                    datasets: [{
                        label: 'Total Vehicles',
                        data: monthlyData.map(m => m.totalVehicles),
                        borderColor: 'rgba(54, 162, 235, 1)',
                        backgroundColor: 'rgba(54, 162, 235, 0.1)',
                        fill: true
                    }, {
                        label: 'Through Traffic',
                        data: monthlyData.map(m => m.throughTraffic),
                        borderColor: 'rgba(255, 99, 132, 1)',
                        backgroundColor: 'rgba(255, 99, 132, 0.1)',
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        });

        // Auto-refresh every 5 minutes
        setTimeout(() => {
            window.location.reload();
        }, 5 * 60 * 1000);

        // Initialize date pickers
        flatpickr("#startDate", {
            dateFormat: "Y-m-d",
            maxDate: "today"
        });
        flatpickr("#endDate", {
            dateFormat: "Y-m-d",
            maxDate: "today"
        });

        // Initialize DataTables with custom filtering
        let eventsTable;
        $(document).ready(function() {
            eventsTable = $('#eventsTable').DataTable({
                order: [[1, 'desc']], // Sort by entry time by default
                pageLength: 25,
                dom: 'Bfrtip',
                buttons: [
                    {
                        extend: 'collection',
                        text: 'Export',
                        buttons: [
                            'copy',
                            'excel',
                            'csv',
                            'pdf',
                            'print'
                        ]
                    }
                ],
                language: {
                    search: "Search events:"
                }
            });

            // Custom filtering function
            $.fn.dataTable.ext.search.push(function(settings, data, dataIndex) {
                const row = eventsTable.row(dataIndex).data();
                const duration = parseInt(row[3]) || 0;
                const eventType = row[4].toLowerCase();
                const vrm = row[0].toLowerCase();
                const searchVrm = $('#vrmSearch').val().toLowerCase();

                // Duration filter
                const durationFilter = $('#durationFilter').val();
                if (durationFilter !== 'all') {
                    if (durationFilter === 'short' && duration >= 30) return false;
                    if (durationFilter === 'medium' && (duration < 30 || duration > 120)) return false;
                    if (durationFilter === 'long' && duration <= 120) return false;
                }

                // Event type filter
                const typeFilter = $('#eventType').val();
                if (typeFilter !== 'all' && !eventType.includes(typeFilter)) return false;

                // VRM search
                if (searchVrm && !vrm.includes(searchVrm)) return false;

                return true;
            });
        });

        // Event handling functions
        async function viewEventDetails(eventId) {
            try {
                const response = await fetch(`/api/events/${eventId}`);
                const event = await response.json();
                
                // Populate entry details
                document.getElementById('entryDetails').innerHTML = `
                    <p><strong>Time:</strong> ${new Date(event.entryTime).toLocaleString()}</p>
                    <p><strong>VRM:</strong> ${event.VRM}</p>
                    <p><strong>Camera:</strong> ${event.entryCamera || 'N/A'}</p>
                `;

                // Populate exit details
                document.getElementById('exitDetails').innerHTML = event.exitTime ? `
                    <p><strong>Time:</strong> ${new Date(event.exitTime).toLocaleString()}</p>
                    <p><strong>VRM:</strong> ${event.VRM}</p>
                    <p><strong>Camera:</strong> ${event.exitCamera || 'N/A'}</p>
                    <p><strong>Duration:</strong> ${event.durationMinutes !== null ? Number(event.durationMinutes).toFixed(2) + ' minutes' : '-'} </p>
                ` : '<p class="text-muted">Still parked</p>';

                // Populate images
                const imagesHtml = [];
                if (event.entryImage) {
                    imagesHtml.push(`
                        <div class="col-md-6 mb-3">
                            <h6>Entry Image</h6>
                            <img src="${event.entryImage}" class="event-image" onclick="showFullImage(this.src)">
                        </div>
                    `);
                }
                if (event.exitImage) {
                    imagesHtml.push(`
                        <div class="col-md-6 mb-3">
                            <h6>Exit Image</h6>
                            <img src="${event.exitImage}" class="event-image" onclick="showFullImage(this.src)">
                        </div>
                    `);
                }
                document.getElementById('eventImages').innerHTML = imagesHtml.join('');

                const modal = new bootstrap.Modal(document.getElementById('eventDetailsModal'));
                modal.show();
            } catch (error) {
                console.error('Error fetching event details:', error);
                alert('Error loading event details');
            }
        }

        function showFullImage(src) {
            const modal = new bootstrap.Modal(document.getElementById('imageModal'));
            document.getElementById('modalImage').src = src;
            modal.show();
        }

        // Filter handling
        $('#dateRange').on('change', function() {
            const value = $(this).val();
            if (value === 'custom') {
                $('#customDateRange').addClass('active');
            } else {
                $('#customDateRange').removeClass('active');
                updateDateFilter(value);
            }
            updateActiveFilters();
        });

        function updateDateFilter(range) {
            const now = new Date();
            let startDate, endDate;

            switch(range) {
                case 'today':
                    startDate = new Date(now.setHours(0,0,0,0));
                    endDate = new Date();
                    break;
                case 'yesterday':
                    startDate = new Date(now.setDate(now.getDate() - 1));
                    startDate.setHours(0,0,0,0);
                    endDate = new Date(now.setHours(23,59,59,999));
                    break;
                case 'week':
                    startDate = new Date(now.setDate(now.getDate() - 7));
                    endDate = new Date();
                    break;
                case 'month':
                    startDate = new Date(now.setDate(now.getDate() - 30));
                    endDate = new Date();
                    break;
                default:
                    return;
            }

            eventsTable.draw();
        }

        $('#durationFilter, #eventType').on('change', function() {
            eventsTable.draw();
            updateActiveFilters();
        });

        $('#vrmSearch').on('input', function() {
            eventsTable.draw();
            updateActiveFilters();
        });

        function updateActiveFilters() {
            const filters = [];
            const dateRange = $('#dateRange').val();
            const duration = $('#durationFilter').val();
            const eventType = $('#eventType').val();
            const vrm = $('#vrmSearch').val();

            if (dateRange !== 'today') {
                filters.push(`<span class="badge bg-primary filter-badge">Date: ${dateRange}</span>`);
            }
            if (duration !== 'all') {
                filters.push(`<span class="badge bg-info filter-badge">Duration: ${duration}</span>`);
            }
            if (eventType !== 'all') {
                filters.push(`<span class="badge bg-success filter-badge">Type: ${eventType}</span>`);
            }
            if (vrm) {
                filters.push(`<span class="badge bg-warning filter-badge">VRM: ${vrm}</span>`);
            }

            $('#activeFilters').html(filters.join(''));
        }
    </script>
</body>
</html> 