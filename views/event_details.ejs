<div class="container-fluid py-4">
    <div class="row">
        <div class="col-12">
            <div class="card mb-4">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        Event Details - <%= event.carparkName %>
                        <small class="text-muted">(<%= event.siteId %>)</small>
                    </h5>
                    <a href="/events" class="btn btn-outline-secondary btn-sm">
                        <i class="fas fa-arrow-left"></i> Back to Events
                    </a>
                </div>
                <div class="card-body">
                    <!-- Split Event Button -->
                    <div class="mb-3">
                        <button class="btn btn-danger" data-bs-toggle="modal" data-bs-target="#splitEventModal">
                            Split Event
                        </button>
                    </div>
                    <!-- Basic Event Information -->
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <h6 class="mb-3">Event Information</h6>
                            <table class="table table-sm">
                                <tr>
                                    <th style="width: 150px;">Vehicle Registration</th>
                                    <td><%= event.VRM %></td>
                                </tr>
                                <tr>
                                    <th>Entry Time</th>
                                    <td><%= new Date(event.entryTime).toLocaleString() %></td>
                                </tr>
                                <tr>
                                    <th>Exit Time</th>
                                    <td><%= event.exitTime ? new Date(event.exitTime).toLocaleString() : 'Still Parked' %></td>
                                </tr>
                                <tr>
                                    <th>Duration</th>
                                    <td><%= event.durationMinutes !== null ? Number(event.durationMinutes).toFixed(1) + ' minutes' : '-' %></td>
                                </tr>
                                <tr>
                                    <th>Through Traffic</th>
                                    <td><%= event.throughTraffic ? 'Yes' : 'No' %></td>
                                </tr>
                            </table>
                        </div>
                    </div>

                    <!-- Entry Detection Details -->
                    <div class="row mb-4">
                        <div class="col-12">
                            <h6 class="mb-3">Entry Detection</h6>
                            <div class="row">
                                <div class="col-md-6">
                                    <table class="table table-sm">
                                        <tr>
                                            <th style="width: 150px;">Camera</th>
                                            <td><%= event.entryCameraName %></td>
                                        </tr>
                                        <tr>
                                            <th>Direction</th>
                                            <td><%= event.entryDirection || '-' %></td>
                                        </tr>
                                        <tr>
                                            <th>Confidence</th>
                                            <td><%= event.entryConfidence %>%</td>
                                        </tr>
                                        <tr>
                                            <th>Tag</th>
                                            <td><%= event.entryTag || '-' %></td>
                                        </tr>
                                        <tr>
                                            <th>Tag Confidence</th>
                                            <td><%= event.entryTagConfidence ? event.entryTagConfidence + '%' : '-' %></td>
                                        </tr>
                                        <tr>
                                            <th>Country</th>
                                            <td><%= event.entryCountry || '-' %></td>
                                        </tr>
                                    </table>
                                </div>
                                <div class="col-md-6">
                                    <div class="d-flex gap-3">
                                        <div>
                                            <h6 class="text-muted mb-2">Image 1</h6>
                                            <img src="/image/<%= event.entryDetectionId %>/1" 
                                                 alt="Entry Image 1" 
                                                 class="img-thumbnail" 
                                                 style="width: 200px; height: 150px; object-fit: cover; cursor: pointer;"
                                                 onclick="viewImage('<%= event.entryDetectionId %>', 1)"
                                                 onerror="this.src='/images/placeholder.jpg'">
                                        </div>
                                        <div>
                                            <h6 class="text-muted mb-2">Image 2</h6>
                                            <img src="/image/<%= event.entryDetectionId %>/2" 
                                                 alt="Entry Image 2" 
                                                 class="img-thumbnail" 
                                                 style="width: 200px; height: 150px; object-fit: cover; cursor: pointer;"
                                                 onclick="viewImage('<%= event.entryDetectionId %>', 2)"
                                                 onerror="this.src='/images/placeholder.jpg'">
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Exit Detection Details -->
                    <% if (event.exitTime) { %>
                    <div class="row mb-4">
                        <div class="col-12">
                            <h6 class="mb-3">Exit Detection</h6>
                            <div class="row">
                                <div class="col-md-6">
                                    <table class="table table-sm">
                                        <tr>
                                            <th style="width: 150px;">Camera</th>
                                            <td><%= event.exitCameraName %></td>
                                        </tr>
                                        <tr>
                                            <th>Direction</th>
                                            <td><%= event.exitDirection || '-' %></td>
                                        </tr>
                                        <tr>
                                            <th>Confidence</th>
                                            <td><%= event.exitConfidence %>%</td>
                                        </tr>
                                        <tr>
                                            <th>Tag</th>
                                            <td><%= event.exitTag || '-' %></td>
                                        </tr>
                                        <tr>
                                            <th>Tag Confidence</th>
                                            <td><%= event.exitTagConfidence ? event.exitTagConfidence + '%' : '-' %></td>
                                        </tr>
                                        <tr>
                                            <th>Country</th>
                                            <td><%= event.exitCountry || '-' %></td>
                                        </tr>
                                    </table>
                                </div>
                                <div class="col-md-6">
                                    <div class="d-flex gap-3">
                                        <div>
                                            <h6 class="text-muted mb-2">Image 1</h6>
                                            <img src="/image/<%= event.exitDetectionId %>/1" 
                                                 alt="Exit Image 1" 
                                                 class="img-thumbnail" 
                                                 style="width: 200px; height: 150px; object-fit: cover; cursor: pointer;"
                                                 onclick="viewImage('<%= event.exitDetectionId %>', 1)"
                                                 onerror="this.src='/images/placeholder.jpg'">
                                        </div>
                                        <div>
                                            <h6 class="text-muted mb-2">Image 2</h6>
                                            <img src="/image/<%= event.exitDetectionId %>/2" 
                                                 alt="Exit Image 2" 
                                                 class="img-thumbnail" 
                                                 style="width: 200px; height: 150px; object-fit: cover; cursor: pointer;"
                                                 onclick="viewImage('<%= event.exitDetectionId %>', 2)"
                                                 onerror="this.src='/images/placeholder.jpg'">
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <% } %>

                    <!-- PCNs -->
                    <% if (pcns && pcns.length > 0) { %>
                    <div class="row mb-4">
                        <div class="col-12">
                            <h6 class="mb-3">Parking Charge Notices</h6>
                            <div class="table-responsive">
                                <table class="table table-sm">
                                    <thead>
                                        <tr>
                                            <th>PCN #</th>
                                            <th>Issue Date</th>
                                            <th>Due Date</th>
                                            <th>Amount</th>
                                            <th>Status</th>
                                            <th>Reason</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <% pcns.forEach(pcn => { %>
                                            <tr>
                                                <td><%= pcn.id %></td>
                                                <td><%= new Date(pcn.issueDate).toLocaleDateString() %></td>
                                                <td><%= new Date(pcn.dueDate).toLocaleDateString() %></td>
                                                <td>£<%= pcn.amount.toFixed(2) %></td>
                                                <td>
                                                    <span class="badge bg-<%= 
                                                        pcn.status === 'paid' ? 'success' :
                                                        pcn.status === 'cancelled' ? 'danger' :
                                                        pcn.status === 'appealed' ? 'warning' : 'primary'
                                                    %>">
                                                        <%= pcn.status.charAt(0).toUpperCase() + pcn.status.slice(1) %>
                                                    </span>
                                                </td>
                                                <td><%= pcn.reason %></td>
                                            </tr>
                                        <% }); %>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    <% } %>

                    <!-- Detection Flags -->
                    <% if ((entryFlags && entryFlags.length > 0) || (exitFlags && exitFlags.length > 0)) { %>
                    <div class="row">
                        <div class="col-12">
                            <h6 class="mb-3">Detection Flags</h6>
                            <% if (entryFlags && entryFlags.length > 0) { %>
                                <div class="mb-3">
                                    <h6 class="text-muted">Entry Detection Flags</h6>
                                    <div class="d-flex gap-2">
                                        <% entryFlags.forEach(flag => { %>
                                            <span class="badge bg-<%= 
                                                flag.flagType === 'ignore' ? 'secondary' :
                                                flag.flagType === 'problematic' ? 'danger' :
                                                flag.flagType === 'test' ? 'info' : 'warning'
                                            %>">
                                                <%= flag.flagType.charAt(0).toUpperCase() + flag.flagType.slice(1) %>
                                                <% if (flag.description) { %>
                                                    - <%= flag.description %>
                                                <% } %>
                                            </span>
                                        <% }); %>
                                    </div>
                                </div>
                            <% } %>
                            <% if (exitFlags && exitFlags.length > 0) { %>
                                <div>
                                    <h6 class="text-muted">Exit Detection Flags</h6>
                                    <div class="d-flex gap-2">
                                        <% exitFlags.forEach(flag => { %>
                                            <span class="badge bg-<%= 
                                                flag.flagType === 'ignore' ? 'secondary' :
                                                flag.flagType === 'problematic' ? 'danger' :
                                                flag.flagType === 'test' ? 'info' : 'warning'
                                            %>">
                                                <%= flag.flagType.charAt(0).toUpperCase() + flag.flagType.slice(1) %>
                                                <% if (flag.description) { %>
                                                    - <%= flag.description %>
                                                <% } %>
                                            </span>
                                        <% }); %>
                                    </div>
                                </div>
                            <% } %>
                        </div>
                    </div>
                    <% } %>

                    <!-- Related Events for this VRM at this Car Park -->
                    <% if (relatedEvents && relatedEvents.length > 0) { %>
                    <div class="row mb-4">
                        <div class="col-12">
                            <h6 class="mb-3">Other Events for <%= event.VRM %> at <%= event.carparkName %></h6>
                            <div class="table-responsive">
                                <table class="table table-sm">
                                    <thead>
                                        <tr>
                                            <th>Entry Time</th>
                                            <th>Exit Time</th>
                                            <th>Duration</th>
                                            <th>Through Traffic</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <% relatedEvents.forEach(ev => { %>
                                            <tr>
                                                <td><%= new Date(ev.entryTime).toLocaleString() %></td>
                                                <td><%= ev.exitTime ? new Date(ev.exitTime).toLocaleString() : 'Still Parked' %></td>
                                                <td><%= ev.durationMinutes !== null ? Number(ev.durationMinutes).toFixed(1) + ' minutes' : '-' %></td>
                                                <td><%= ev.throughTraffic ? 'Yes' : 'No' %></td>
                                                <td><a href="/events/<%= ev.id %>" class="btn btn-sm btn-outline-primary">View</a></td>
                                            </tr>
                                        <% }); %>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    <% } %>

                    <!-- All Detections for this VRM at this Car Park -->
                    <% if (relatedDetections && relatedDetections.length > 0) { %>
                    <div class="row mb-4">
                        <div class="col-12">
                            <h6 class="mb-3">All Detections for <%= event.VRM %> at <%= event.carparkName %></h6>
                            <div class="table-responsive">
                                <table class="table table-sm table-hover">
                                    <thead>
                                        <tr>
                                            <th>Timestamp</th>
                                            <th>Camera</th>
                                            <th>Direction</th>
                                            <th>Confidence</th>
                                            <th>Tag</th>
                                            <th>Tag Confidence</th>
                                            <th>Country</th>
                                            <th>Images</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <% relatedDetections.forEach(det => { %>
                                            <tr class="detection-row" data-detection-id="<%= det.id %>" style="cursor: pointer;">
                                                <td><%= new Date(det.timestamp).toLocaleString() %></td>
                                                <td><%= det.cameraID %></td>
                                                <td><%= det.direction %></td>
                                                <td><%= det.confidence %></td>
                                                <td><%= det.tag || '-' %></td>
                                                <td><%= det.tagConfidence ? det.tagConfidence + '%' : '-' %></td>
                                                <td><%= det.country || '-' %></td>
                                                <td>
                                                    <div class="d-flex gap-2">
                                                        <img src="/image/<%= det.id %>/1" 
                                                             alt="Image 1" 
                                                             class="img-thumbnail" 
                                                             style="width: 50px; height: 50px; object-fit: cover; cursor: pointer;"
                                                             onclick="viewImage('<%= det.id %>', 1); event.stopPropagation();"
                                                             onerror="this.src='/images/placeholder.jpg'">
                                                        <img src="/image/<%= det.id %>/2" 
                                                             alt="Image 2" 
                                                             class="img-thumbnail" 
                                                             style="width: 50px; height: 50px; object-fit: cover; cursor: pointer;"
                                                             onclick="viewImage('<%= det.id %>', 2); event.stopPropagation();"
                                                             onerror="this.src='/images/placeholder.jpg'">
                                                    </div>
                                                </td>
                                                <td>
                                                    <button class="btn btn-sm btn-outline-primary" onclick="viewDetectionDetails('<%= det.id %>'); event.stopPropagation();">
                                                        Details
                                                    </button>
                                                </td>
                                            </tr>
                                        <% }); %>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    <% } %>

                    <!-- Event Status -->
                    <div class="row mb-3">
                        <div class="col-md-8">
                            <h2>Event Details</h2>
                            <span>
                                <% if (event.status === 'whitelisted') { %>
                                    <span class="badge bg-success"><i class="bi bi-shield-check"></i> Whitelisted</span>
                                <% } else if (event.status === 'paid') { %>
                                    <span class="badge bg-primary"><i class="bi bi-currency-pound"></i> Paid</span>
                                <% } else if (event.status === 'unpaid') { %>
                                    <span class="badge bg-danger"><i class="bi bi-exclamation-circle"></i> Unpaid</span>
                                <% } else { %>
                                    <span class="badge bg-secondary">-</span>
                                <% } %>
                            </span>
                            <div class="mt-2">
                                <strong>Whitelist Checked:</strong> <%= event.whitelistCheckedAt ? new Date(event.whitelistCheckedAt).toLocaleString() : 'Never' %><br>
                                <strong>Payment Checked:</strong> <%= event.paymentCheckedAt ? new Date(event.paymentCheckedAt).toLocaleString() : 'Never' %>
                            </div>
                            <% if (event.status === 'whitelisted' && event.whitelistMatch) { %>
                                <div class="alert alert-success mt-2">
                                    <strong>Whitelist Match:</strong><br>
                                    VRM: <%= event.whitelistMatch.vrm %><br>
                                    Car Park: <%= event.whitelistMatch.siteId %><br>
                                    Start: <%= event.whitelistMatch.startDate ? new Date(event.whitelistMatch.startDate).toLocaleDateString() : 'N/A' %><br>
                                    End: <%= event.whitelistMatch.endDate ? new Date(event.whitelistMatch.endDate).toLocaleDateString() : 'Indefinite' %>
                                </div>
                            <% } else if (event.status === 'paid' && event.payment) { %>
                                <div class="alert alert-primary mt-2">
                                    <strong>Payment Details:</strong>
                                    <table class="table table-sm mt-2">
                                        <tr><th>Amount</th><td>£<%= event.payment.amount.toFixed(2) %></td></tr>
                                        <tr><th>Reference</th><td><%= event.payment.reference %></td></tr>
                                        <tr><th>Paid At</th><td><%= new Date(event.payment.paidAt).toLocaleString() %></td></tr>
                                    </table>
                                </div>
                            <% } else if (event.status === 'unpaid') { %>
                                <div class="alert alert-danger mt-2">No valid payment or whitelist found for this event.</div>
                                <button class="btn btn-outline-success mt-2" disabled>Record Payment</button>
                            <% } %>
                            <button class="btn btn-outline-info mt-2" id="recheckStatusBtn"><i class="bi bi-arrow-repeat"></i> Re-check Status</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Image Preview Modal -->
<div class="modal fade" id="imagePreviewModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Image Preview</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body text-center">
                <img id="previewImage" class="img-fluid" alt="Detection Image">
            </div>
        </div>
    </div>
</div>

<!-- Detection Details Modal -->
<div class="modal fade" id="detectionDetailsModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Detection Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-6">
                        <h6>Detection Information</h6>
                        <table class="table table-sm" id="detectionInfoTable">
                            <!-- Will be populated by JavaScript -->
                        </table>
                    </div>
                    <div class="col-md-6">
                        <h6>Images</h6>
                        <div class="d-flex gap-3">
                            <div>
                                <h6 class="text-muted mb-2">Image 1</h6>
                                <img id="modalImage1" class="img-thumbnail" style="width: 200px; height: 150px; object-fit: cover; cursor: pointer;" onclick="viewImage(currentDetectionId, 1)">
                            </div>
                            <div>
                                <h6 class="text-muted mb-2">Image 2</h6>
                                <img id="modalImage2" class="img-thumbnail" style="width: 200px; height: 150px; object-fit: cover; cursor: pointer;" onclick="viewImage(currentDetectionId, 2)">
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Split Event Modal -->
<div class="modal fade" id="splitEventModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Split Event</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Select the detection after which to split this event. All detections after the selected one will form a new event.</p>
                <table class="table table-sm">
                    <thead>
                        <tr>
                            <th>Timestamp</th>
                            <th>Camera</th>
                            <th>Direction</th>
                            <th>Confidence</th>
                            <th>Tag</th>
                            <th>Country</th>
                            <th>Select Split</th>
                        </tr>
                    </thead>
                    <tbody>
                        <% relatedDetections.forEach((det, idx) => { %>
                            <tr>
                                <td><%= new Date(det.timestamp).toLocaleString() %></td>
                                <td><%= det.cameraID %></td>
                                <td><%= det.direction %></td>
                                <td><%= det.confidence %></td>
                                <td><%= det.tag || '-' %></td>
                                <td><%= det.country || '-' %></td>
                                <td>
                                    <% if (idx < relatedDetections.length - 1) { %>
                                        <button class="btn btn-sm btn-outline-primary" onclick="splitEventAt('<%= event.id %>', '<%= det.id %>')">Split Here</button>
                                    <% } %>
                                </td>
                            </tr>
                        <% }); %>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<script>
let currentDetectionId = null;

// Add click handler to detection rows
document.addEventListener('DOMContentLoaded', function() {
    document.querySelectorAll('.detection-row').forEach(row => {
        row.addEventListener('click', function() {
            const detectionId = this.dataset.detectionId;
            viewDetectionDetails(detectionId);
        });
    });
});

function viewDetectionDetails(detectionId) {
    currentDetectionId = detectionId;
    
    // Fetch detection details
    fetch(`/api/detection/${detectionId}`)
        .then(response => response.json())
        .then(detection => {
            // Update modal content
            const table = document.getElementById('detectionInfoTable');
            table.innerHTML = `
                <tr><th>ID</th><td>${detection.id}</td></tr>
                <tr><th>Timestamp</th><td>${new Date(detection.timestamp).toLocaleString()}</td></tr>
                <tr><th>Camera</th><td>${detection.cameraID}</td></tr>
                <tr><th>Direction</th><td>${detection.direction || '-'}</td></tr>
                <tr><th>Confidence</th><td>${detection.confidence}%</td></tr>
                <tr><th>Tag</th><td>${detection.tag || '-'}</td></tr>
                <tr><th>Tag Confidence</th><td>${detection.tagConfidence ? detection.tagConfidence + '%' : '-'}</td></tr>
                <tr><th>Country</th><td>${detection.country || '-'}</td></tr>
                <tr><th>Processed</th><td>${detection.processed ? 'Yes' : 'No'}</td></tr>
                <tr><th>Processed At</th><td>${detection.processed_at ? new Date(detection.processed_at).toLocaleString() : '-'}</td></tr>
            `;
            
            // Update images
            document.getElementById('modalImage1').src = `/image/${detectionId}/1`;
            document.getElementById('modalImage2').src = `/image/${detectionId}/2`;
            
            // Show modal
            new bootstrap.Modal(document.getElementById('detectionDetailsModal')).show();
        })
        .catch(error => {
            console.error('Error fetching detection details:', error);
            alert('Error loading detection details');
        });
}

function viewImage(detectionId, imageType) {
    const img = document.getElementById('previewImage');
    img.src = `/image/${detectionId}/${imageType}`;
    new bootstrap.Modal(document.getElementById('imagePreviewModal')).show();
}

function splitEventAt(eventId, detectionId) {
    if (!confirm('Are you sure you want to split this event at the selected detection?')) return;
    fetch(`/api/events/${eventId}/split`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ splitDetectionId: detectionId })
    })
    .then(res => res.json())
    .then(data => {
        if (data.success) {
            alert('Event split successfully!');
            window.location.reload();
        } else {
            alert('Error splitting event: ' + (data.error || 'Unknown error'));
        }
    })
    .catch(err => {
        alert('Error splitting event: ' + err);
    });
}

document.addEventListener('DOMContentLoaded', function() {
    var btn = document.getElementById('recheckStatusBtn');
    if (btn) {
        btn.onclick = async function() {
            const eventId = '<%= event.id %>';
            const res = await fetch(`/admin/events/${eventId}/finalize`, { method: 'POST' });
            if (res.ok) window.location.reload();
            else alert('Failed to re-check status');
        };
    }
});
</script> 